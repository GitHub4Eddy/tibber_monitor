{"name":"Tibber Monitor","type":"com.fibaro.genericDevice","apiVersion":"1.2","initialProperties":{"viewLayout":{"$jason":{"body":{"header":{"style":{"height":"0"},"title":"quickApp_device_1125"},"sections":{"items":[{"components":[{"name":"label1","style":{"weight":"1.2"},"text":"Label1","type":"label","visible":true},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"}]}},"head":{"title":"quickApp_device_1125"}}},"uiCallbacks":[],"quickAppVariables":[{"name":"token","type":"string","value":"476c477d8a039529478ebd690d35ddd80e3308ffc49b59c65b142321aee963a4"},{"name":"homeNr","type":"string","value":"1"},{"name":"extraCost","type":"string","value":" 0.3649"},{"name":"interval","type":"string","value":"3600"},{"name":"httpTimeout","type":"string","value":"5"},{"name":"debugLevel","type":"string","value":"3"},{"name":"setGlobalVar","type":"string","value":"false"},{"name":"icon","type":"string","value":"1119"}],"typeTemplateInitialized":true},"files":[{"name":"main","isMain":true,"isOpen":true,"content":"-- QUICKAPP Tibber Monitor\n\n-- This QuickApp gets todays an tomorrows energy prices from the Tibber platform. \n-- Next to the current prices the lowest and highest price for the next 12 hours is calculated.\n-- Tax and extra cost (cable owner) are included in the hourly, daily, monthly, yearly and total cost.  \n-- All values are displayed in the labels. \n-- Child devices are available for:\n   -- Hourly energy usage\n   -- Hourly energy cost\n   -- Todays energy usage (com.fibaro.energyMeter with automatic rateType=consumption for Fibaro Energy Panel)\n   -- Todays energy cost (including fees)\n   -- Monthly energy usage\n   -- Monthly energy cost\n   -- Yearly energy usage\n   -- Yearly energy cost\n   -- Total energy usage\n   -- Total energy cost\n   -- Actual price now\n   -- Minumum price today (for the next 12 hours)\n   -- Maximum price today (for the next 12 hours)\n   -- Percentage +1 hour (compaired to actual price now, positive value means an increase of the price, negative value means a decrease of the price)\n   -- Percentage +2 hour\n   -- Percentage +3 hour\n   -- Percentage +4 hour\n   -- Percentage +5 hour\n-- These values can be used to control appliances according to the lowest and forecast prices during the day. \n\n-- To communicate with the API you need to acquire a OAuth access token and pass this along with every request passed to the server.\n-- A Personal Access Token give you access to your data and your data only. \n-- This is ideal for DIY people that want to leverage the Tibber platform to extend the smartness of their home. \n-- Such a token can be acquired here: https://developer.tibber.com\n\n-- When creating your access token or OAuth client you’ll be asked which scopes you want the access token to be associated with. \n-- These scopes tells the API which data and operations the client is allowed to perfom on the user’s behalf. \n-- The scopes your app requires depend on the type of data it is trying to request. \n-- If you for example need access to user information you add the USER scope. \n-- If information about the users homes is needed you add the appropiate HOME scopes.\n\n-- Tomorrow values are available from 13:00 hour\n-- If you have more than one home in your subscription, you need to fill in your home number the change between your homes. \n\n-- Tibber API documentation: https://developer.tibber.com/docs/guides/calling-api\n-- Tibber API explorer: https://developer.tibber.com/explorer\n\n\n-- ToDo:\n-- Current energy usage Watt (real time subscription = QuickApp with WebSocket?) (main device = powerSensor)\n-- Create global variables for ?\n\n\n-- Changes version 0.5 (1st Januari 2021)\n-- Changed main device to generic.device\n-- Changed Tax calculations\n-- Added child devices monthly and total energy and cost\n-- Calculated the daily, monthly, yearly and total energy, cost and tax to get this day, this month, this year and total values\n-- Solved a bug showing more than 12 prices just after midnight\n-- Solved handling nil values at beginning of year, etc\n\n\n-- Changes version 0.3 (30th December 2021)\n-- Added quickapp variable homeNr to select which home if you have more than one in your subscription\n\n-- Changes version 0.2 (29th December 2021)\n-- Added all child devices\n-- Added QuickApp variable for extra cost and added the cost to the calculations\n-- Replaced \"null\" values in response to prevent errors\n-- Limited values to next 12 hours\n\n-- Changes version 0.1 (23rd December 2021)\n-- Initial version\n\n\n-- Variables (mandatory and created automatically): \n-- token = Authorization token (see the Tibber website: https://developer.tibber.com)\n-- homeNr = Tibber home (nodes) number if you have more than one home (default = 1)\n-- extraCost = Extra cost per kWh for Tibber and Cable owner, decimals with dot, not komma (default = 0)\n-- interval = Interval in seconds to get the data from the Tibber Platform. The default is 3600 seconds (60 minutes). (Tibber has a rate limit of 100 requests in 5 minutes per IP address)\n-- debugLevel = Number (1=some, 2=few, 3=all, 4=simulation mode) (default = 1)\n-- setGlobalVar = true or false, whether you want tu use the Global Variables (default = false)\n-- icon = User defined icon number (add the icon via another device and lookup the number) (default = 0)\n\n\n-- No editing of this code is needed \n\n\n-- Child Devices\n\nclass 'hEnergy'(QuickAppChild)\nfunction hEnergy:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction hEnergy:updateValue(data) \n  self:updateProperty(\"value\", data.hEnergy)\n  self:updateProperty(\"unit\", \"kWh\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'hCost'(QuickAppChild)\nfunction hCost:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction hCost:updateValue(data) \n  self:updateProperty(\"value\", data.hCost+(extraCost*data.hEnergy))\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", string.format(\"%.2f\",data.hCost) ..\" + \" ..string.format(\"%.2f\",extraCost*data.hEnergy))\nend\n\nclass 'dEnergy'(QuickAppChild)\nfunction dEnergy:__init(dev)\n  QuickAppChild.__init(self,dev)\n  if fibaro.getValue(self.id, \"rateType\") ~= \"consumption\" then \n    self:updateProperty(\"rateType\", \"consumption\")\n    self:warning(\"Changed rateType interface of Daily Energy child device (\" ..self.id ..\") to consumption\")\n  end\nend\nfunction dEnergy:updateValue(data) \n  self:updateProperty(\"value\", data.dEnergy)\n  self:updateProperty(\"unit\", \"kWh\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'dCost'(QuickAppChild)\nfunction dCost:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction dCost:updateValue(data) \n  self:updateProperty(\"value\", data.dCost+(extraCost*data.dEnergy))\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", string.format(\"%.2f\",data.dCost) ..\" + \" ..string.format(\"%.2f\",extraCost*data.dEnergy))\nend\n\nclass 'mEnergy'(QuickAppChild)\nfunction mEnergy:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction mEnergy:updateValue(data) \n  self:updateProperty(\"value\", data.mEnergy)\n  self:updateProperty(\"unit\", \"kWh\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'mCost'(QuickAppChild)\nfunction mCost:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction mCost:updateValue(data) \n  self:updateProperty(\"value\", data.mCost+(extraCost*data.mEnergy))\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", string.format(\"%.2f\",data.mCost) ..\" + \" ..string.format(\"%.2f\",extraCost*data.mEnergy))\nend\n\nclass 'yEnergy'(QuickAppChild)\nfunction yEnergy:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction yEnergy:updateValue(data) \n  self:updateProperty(\"value\", data.yEnergy)\n  self:updateProperty(\"unit\", \"kWh\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'yCost'(QuickAppChild)\nfunction yCost:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction yCost:updateValue(data) \n  self:updateProperty(\"value\", data.yCost+(extraCost*data.yEnergy))\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", string.format(\"%.2f\",data.yCost) ..\" + \" ..string.format(\"%.2f\",extraCost*data.yEnergy))\nend\n\nclass 'tEnergy'(QuickAppChild)\nfunction tEnergy:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction tEnergy:updateValue(data) \n  self:updateProperty(\"value\", data.tEnergy)\n  self:updateProperty(\"unit\", \"kWh\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'tCost'(QuickAppChild)\nfunction tCost:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction tCost:updateValue(data) \n  self:updateProperty(\"value\", data.tCost+(extraCost*data.tEnergy))\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", string.format(\"%.2f\",data.tCost) ..\" + \" ..string.format(\"%.2f\",extraCost*data.tEnergy))\nend\n\nclass 'hPrice'(QuickAppChild)\nfunction hPrice:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction hPrice:updateValue(data) \n  self:updateProperty(\"value\", data.tPrice)\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", data.level)\nend\n\nclass 'minPrice'(QuickAppChild)\nfunction minPrice:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction minPrice:updateValue(data) \n  self:updateProperty(\"value\", data.minPrice)\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", data.minStartsAt ..\" \" ..data.minLevel)\nend\n\nclass 'maxPrice'(QuickAppChild)\nfunction maxPrice:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction maxPrice:updateValue(data) \n  self:updateProperty(\"value\", data.maxPrice)\n  self:updateProperty(\"unit\", data.currency)\n  self:updateProperty(\"log\", data.maxStartsAt ..\" \"..data.maxLevel)\nend\n\nclass 'h1Percentage'(QuickAppChild)\nfunction h1Percentage:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction h1Percentage:updateValue(data) \n  self:updateProperty(\"value\", data.h1Percentage)\n  self:updateProperty(\"unit\", \"%\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'h2Percentage'(QuickAppChild)\nfunction h2Percentage:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction h2Percentage:updateValue(data) \n  self:updateProperty(\"value\", data.h2Percentage)\n  self:updateProperty(\"unit\", \"%\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'h3Percentage'(QuickAppChild)\nfunction h3Percentage:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction h3Percentage:updateValue(data) \n  self:updateProperty(\"value\", data.h3Percentage)\n  self:updateProperty(\"unit\", \"%\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'h4Percentage'(QuickAppChild)\nfunction h4Percentage:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction h4Percentage:updateValue(data) \n  self:updateProperty(\"value\", data.h4Percentage)\n  self:updateProperty(\"unit\", \"%\")\n  self:updateProperty(\"log\", \" \")\nend\n\nclass 'h5Percentage'(QuickAppChild)\nfunction h5Percentage:__init(dev)\n  QuickAppChild.__init(self,dev)\nend\nfunction h5Percentage:updateValue(data) \n  self:updateProperty(\"value\", data.h5Percentage)\n  self:updateProperty(\"unit\", \"%\")\n  self:updateProperty(\"log\", \" \")\nend\n\n\nlocal function getChildVariable(child,varName)\n  for _,v in ipairs(child.properties.quickAppVariables or {}) do\n    if v.name==varName then return v.value end\n  end\n  return \"\"\nend\n\n\n-- QuickApp functions\n\n\nfunction QuickApp:updateChildDevices() -- Update Child Devices\n  for id,child in pairs(self.childDevices) do \n    child:updateValue(data) \n  end\nend\n\n\nfunction QuickApp:logging(level,text) -- Logging function for debug\n  if tonumber(debugLevel) >= tonumber(level) then \n      self:debug(text)\n  end\nend\n\n\nfunction QuickApp:setGlobalVariable(tag,res) -- Fill the Global Variables\n  if setGlobalVar then -- self:setGlobalVariable(\"[nameOfGlobal]_\"..plugin.mainDeviceId,[value])\n    if api.get(\"/globalVariables/\"..tag) == nil then\n      local responseData, status = api.post(\"/globalVariables/\",{value=(json.encode(res)),name=tag})\n      self:trace(\"Global Variable created: \" ..tag ..\" / status: \" ..status) \n    else\n      local responseData, status = api.put(\"/globalVariables/\"..tag,{value=(json.encode(res))})\n    end\n  else\n    if api.get(\"/globalVariables/\"..tag) then\n      self:deleteGlobalVariable(tag) -- If the Global Variable exists, delete it\n    end\n  end\nend\n\n\nfunction QuickApp:deleteGlobalVariable(tag) -- Delete the Global Variables\n   local responseData, status = api.delete(\"/globalVariables/\"..tag) \n   self:trace(\"Global Variable deleted: \" ..tag ..\" / status: \" ..status)\nend\n\n\nfunction QuickApp:updateProperties() -- Update the properties\n  self:logging(3,\"updateProperties\")\n  --self:updateProperty(\"value\", 0) -- For future use\n  --self:updateProperty(\"unit\", \"\")\n  self:updateProperty(\"log\", data.startsAt)\nend\n\n\nfunction QuickApp:updateLabels() -- Update the labels\n  self:logging(3,\"updateLabels\")\n\n  local labelText = \"\"\n  if debugLevel == 4 then\n    labelText = labelText ..\"SIMULATION MODE\" ..\"\\n\\n\"\n  end\n\n  labelText = labelText ..\"Hourly Energy: \" ..data.hEnergy ..\" kWh / Cost: \" ..string.format(\"%.2f\",data.hCost+(extraCost*data.hEnergy)) ..\" \" ..data.currency ..\"\\n\"\n  labelText = labelText ..\"Daily Energy: \" ..data.dEnergy ..\" kWh / Cost: \" ..string.format(\"%.2f\",data.dCost+(extraCost*data.dEnergy)) ..\" \" ..data.currency ..\"\\n\"\n  labelText = labelText ..\"Monthly Energy: \" ..data.mEnergy ..\" kWh / Cost: \" ..string.format(\"%.2f\",data.mCost+(extraCost*data.mEnergy)) ..\" \" ..data.currency ..\"\\n\"\n  labelText = labelText ..\"Yearly Energy: \" ..data.yEnergy ..\" kWh / Cost: \" ..string.format(\"%.2f\",data.yCost+(extraCost*data.yEnergy))  ..\" \" ..data.currency ..\"\\n\"\n  labelText = labelText ..\"Total Energy: \" ..data.tEnergy ..\" kWh / Cost: \" ..string.format(\"%.2f\",data.tCost+(extraCost*data.tEnergy))  ..\" \" ..data.currency ..\"\\n\\n\"\n  \n  labelText = labelText ..\"Actual Price: \" ..data.tPrice ..\" \" ..data.currency ..\" per kWh (\" ..data.level ..\")\" ..\"\\n\"\n  labelText = labelText ..\"Energy: \" ..data.gPrice ..\" \" ..data.currency ..\" / Tax: \" ..data.tax ..\" Cost: \" ..extraCost ..\" \" ..data.currency ..\"\\n\"\n  labelText = labelText ..\"Starts at: \" ..data.startsAt ..\"\\n\\n\"\n  \n  labelText = labelText ..\"Next 12 hours:\" ..\"\\n\"\n  labelText = labelText ..\"Lowest: \" ..data.minPrice ..\" \" ..data.currency ..\" at: \" ..data.minStartsAt ..\" \" ..data.minLevel ..\"\\n\"\n  labelText = labelText ..\"Highest: \" ..data.maxPrice ..\" \" ..data.currency ..\" at: \" ..data.maxStartsAt ..\" \" ..data.maxLevel ..\"\\n\\n\"\n\n  for n in pairs(jsonPrices or {}) do\n    labelText = labelText ..\"Price: \" ..jsonPrices[n].total ..\" \" ..data.currency ..\" at: \" ..jsonPrices[n].hour ..\" \" ..jsonPrices[n].level ..\"\\n\"\n  end\n  \n  self:updateView(\"label1\", \"text\", labelText)\n  self:logging(2,\"Label1: \" ..labelText)\nend\n\n\nfunction QuickApp:getValuesTotal() -- Get Total values from json file \n  self:logging(3,\"getValuesTotal\")\n  data.tEnergy = 0\n  data.tCost = 0\n  for year in pairs(jsonTable.data.viewer.homes[homeNr].yearly.nodes or {}) do -- Sum all years\n    self:logging(3,\"year: \" ..tostring(year))\n    data.tEnergy = data.tEnergy + tonumber(jsonTable.data.viewer.homes[homeNr].yearly.nodes[year].consumption)\n    data.tCost = data.tCost + tonumber(jsonTable.data.viewer.homes[homeNr].yearly.nodes[year].cost)\n  end\n  data.tEnergy = tonumber(string.format(\"%.4f\",data.tEnergy + data.yEnergy)) -- Add last year values\n  data.tCost = tonumber(string.format(\"%.2f\",data.tCost + data.yCost))\n  self:logging(3,\"data.tEnergy: \" ..tostring(data.tEnergy))\n  self:logging(3,\"data.tCost: \" ..tostring(data.tCost))\nend\n\n\nfunction QuickApp:getValuesYearly() -- Get Yearly values from json file \n  self:logging(3,\"getValuesYearly\")\n  data.yEnergy = 0\n  data.yCost = 0\n  for month in pairs(jsonTable.data.viewer.homes[homeNr].monthly.nodes or {}) do -- Sum all months of the year\n    self:logging(3,\"month: \" ..tostring(month))\n    data.yEnergy = data.yEnergy + tonumber(jsonTable.data.viewer.homes[homeNr].monthly.nodes[month].consumption)\n    data.yCost = data.yCost + tonumber(jsonTable.data.viewer.homes[homeNr].monthly.nodes[month].cost)\n  end\n  data.yEnergy = tonumber(string.format(\"%.4f\",data.yEnergy + data.mEnergy)) -- Add last month values\n  data.yCost = tonumber(string.format(\"%.2f\",data.yCost + data.mCost))\n  self:logging(3,\"data.yEnergy: \" ..tostring(data.yEnergy))\n  self:logging(3,\"data.yCost: \" ..tostring(data.yCost))\nend\n\n\nfunction QuickApp:getValuesMonthly() -- Get Monthly values from json file \n  self:logging(3,\"getValuesMonthly\")\n  data.mEnergy = 0\n  data.mCost = 0\n  for day in pairs(jsonTable.data.viewer.homes[homeNr].daily.nodes or {}) do -- Sum all days of the month\n    self:logging(3,\"day: \" ..tostring(day))\n    data.mEnergy = data.mEnergy + tonumber(jsonTable.data.viewer.homes[homeNr].daily.nodes[day].consumption)\n    data.mCost = data.mCost + tonumber(jsonTable.data.viewer.homes[homeNr].daily.nodes[day].cost)\n  end\n  data.mEnergy = tonumber(string.format(\"%.4f\",data.mEnergy + data.dEnergy)) -- Add last days values\n  data.mCost = tonumber(string.format(\"%.2f\",data.mCost + data.dCost))\n  self:logging(3,\"data.mEnergy: \" ..tostring(data.mEnergy))\n  self:logging(3,\"data.mCost: \" ..tostring(data.mCost))\nend\n\nfunction QuickApp:getValuesDaily() -- Get Daily values from json file \n  self:logging(3,\"getValuesDaily\")\n  data.dEnergy = 0\n  data.dCost = 0\n  for hour in pairs(jsonTable.data.viewer.homes[homeNr].hourly.nodes or {}) do  -- Sum all hours of the day\n    self:logging(3,\"hour: \" ..tostring(hour))\n    data.dEnergy = data.dEnergy + tonumber(string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].hourly.nodes[hour].consumption))\n    data.dCost = data.dCost + tonumber(string.format(\"%.2f\",jsonTable.data.viewer.homes[homeNr].hourly.nodes[hour].cost))\n    data.hEnergy = tonumber(string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].hourly.nodes[hour].consumption))\n    data.hCost = tonumber(string.format(\"%.2f\",jsonTable.data.viewer.homes[homeNr].hourly.nodes[hour].cost))\n  end\n  self:logging(3,\"data.dEnergy: \" ..tostring(data.dEnergy))\n  self:logging(3,\"data.dCost: \" ..tostring(data.dCost))\nend\n\n\nfunction QuickApp:getValues() -- Get the values from json file \n  self:logging(3,\"getValues\")\n  \n  self:getValuesDaily()\n  self:getValuesMonthly()\n  self:getValuesYearly()\n  self:getValuesTotal()\n  \n  data.tPrice =   tonumber(string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.current.total))\n  data.gPrice =   tonumber(string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.current.energy))\n  data.tax =      tonumber(string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.current.tax))\n  data.currency = jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.current.currency\n  data.level =    jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.current.level:gsub(\"_\", \" \") \n  data.startsAt = jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.current.startsAt\n  \n  local pattern = \"(%d+)-(%d+)-(%d+)T(%d+):(%d+):(%d+).(%d+)+(%d+):(%d+)\" --2021-12-23T17:00:00.000+01:00\n  local runyear, runmonth, runday, runhour, runminute, runseconds = data.startsAt:match(pattern)\n  local convertedTimestamp = os.time({year = runyear, month = runmonth, day = runday, hour = runhour, min = runminute, sec = runseconds})\n  data.startsAt = os.date(\"%d-%m-%Y %H:%M\", convertedTimestamp)\n\n  for hour in pairs(jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.today or {}) do -- Insert all tadays prices to table jsonPrices\n    if hour-1 >= tonumber(runhour) and hour-1 < tonumber(runhour)+12 then\n      table.insert(jsonPrices,{hour = tostring(hour-1)..\":00\", total = string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.today[hour].total), level = \"(\" ..jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.today[hour].level:gsub(\"_\", \" \")  ..\")\", startsAt = jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.today[hour].startsAt})\n    end\n  end\n\n  for hour in pairs(jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.tomorrow or {}) do -- Insert all tomorrow prices to table jsonPrices\n    if 24-tonumber(runhour)+hour <= 12 then \n      table.insert(jsonPrices,{hour = tostring(hour-1)..\":00\", total = string.format(\"%.4f\",jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.tomorrow[hour].total), level = \"(\" ..jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.tomorrow[hour].level:gsub(\"_\", \" \")  ..\")\", startsAt = jsonTable.data.viewer.homes[homeNr].currentSubscription.priceInfo.tomorrow[hour].startsAt})\n    end\n  end\n  self:logging(3,\"Today and Tomorrow Prices: \" ..json.encode(jsonPrices))\n\n  local total = 0\n  data.minPrice = 999 -- Return to initial value to force new lowest price\n  data.maxPrice = 0 -- Return to initial value to force new highest price\n  for n in pairs(jsonPrices or {}) do\n    total = tonumber(string.format(\"%.4f\",jsonPrices[n].total))\n    if total <= data.minPrice then\n      data.minPrice = tonumber(total)\n      data.minLevel = jsonPrices[n].level\n      data.minStartsAt = jsonPrices[n].hour\n    end\n    if total >= data.maxPrice then\n      data.maxPrice = tonumber(total)\n      data.maxLevel = jsonPrices[n].level \n      data.maxStartsAt = jsonPrices[n].hour\n    end  \n    if n == 2 then\n      data.h1Percentage = (total-data.tPrice)/data.tPrice*100\n    elseif n == 3 then\n      data.h2Percentage = (total-data.tPrice)/data.tPrice*100\n    elseif n == 4 then\n      data.h3Percentage = (total-data.tPrice)/data.tPrice*100\n    elseif n == 5 then\n      data.h4Percentage = (total-data.tPrice)/data.tPrice*100\n    elseif n == 6 then\n      data.h5Percentage = (total-data.tPrice)/data.tPrice*100\n    end\n  end\n  self:logging(3,\"data: \" ..json.encode(data))\nend\n\n\nfunction QuickApp:simData() -- Simulate Tibber Platform\n  self:logging(3,\"simData\")\n  apiResult = '{\"data\":{\"viewer\":{\"homes\":[{\"hourly\":{\"nodes\":[{\"from\":\"2021-12-31T00:00:00.000+01:00\",\"to\":\"2021-12-31T01:00:00.000+01:00\",\"cost\":0.69832125,\"unitPrice\":0.38475,\"unitPriceVAT\":0.07695,\"consumption\":1.815,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T01:00:00.000+01:00\",\"to\":\"2021-12-31T02:00:00.000+01:00\",\"cost\":0.551745225,\"unitPrice\":0.336225,\"unitPriceVAT\":0.067245,\"consumption\":1.641,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T02:00:00.000+01:00\",\"to\":\"2021-12-31T03:00:00.000+01:00\",\"cost\":0.69266925,\"unitPrice\":0.323375,\"unitPriceVAT\":0.064675,\"consumption\":2.142,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T03:00:00.000+01:00\",\"to\":\"2021-12-31T04:00:00.000+01:00\",\"cost\":0.4197159,\"unitPrice\":0.309525,\"unitPriceVAT\":0.061905,\"consumption\":1.356,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T04:00:00.000+01:00\",\"to\":\"2021-12-31T05:00:00.000+01:00\",\"cost\":0.655614,\"unitPrice\":0.3195,\"unitPriceVAT\":0.0639,\"consumption\":2.052,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T05:00:00.000+01:00\",\"to\":\"2021-12-31T06:00:00.000+01:00\",\"cost\":0.550834375,\"unitPrice\":0.3147625,\"unitPriceVAT\":0.0629525,\"consumption\":1.75,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T06:00:00.000+01:00\",\"to\":\"2021-12-31T07:00:00.000+01:00\",\"cost\":0.690819425,\"unitPrice\":0.349075,\"unitPriceVAT\":0.069815,\"consumption\":1.979,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T07:00:00.000+01:00\",\"to\":\"2021-12-31T08:00:00.000+01:00\",\"cost\":0.6880113625,\"unitPrice\":0.3884875,\"unitPriceVAT\":0.0776975,\"consumption\":1.771,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T08:00:00.000+01:00\",\"to\":\"2021-12-31T09:00:00.000+01:00\",\"cost\":0.5173125,\"unitPrice\":0.4171875,\"unitPriceVAT\":0.0834375,\"consumption\":1.24,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T09:00:00.000+01:00\",\"to\":\"2021-12-31T10:00:00.000+01:00\",\"cost\":1.032214375,\"unitPrice\":0.449375,\"unitPriceVAT\":0.089875,\"consumption\":2.297,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T10:00:00.000+01:00\",\"to\":\"2021-12-31T11:00:00.000+01:00\",\"cost\":0.577790475,\"unitPrice\":0.498525,\"unitPriceVAT\":0.099705,\"consumption\":1.159,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T11:00:00.000+01:00\",\"to\":\"2021-12-31T12:00:00.000+01:00\",\"cost\":1.3913659625,\"unitPrice\":0.5766125,\"unitPriceVAT\":0.1153225,\"consumption\":2.413,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T12:00:00.000+01:00\",\"to\":\"2021-12-31T13:00:00.000+01:00\",\"cost\":0.77490735,\"unitPrice\":0.6393625,\"unitPriceVAT\":0.1278725,\"consumption\":1.212,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-31T13:00:00.000+01:00\",\"to\":\"2021-12-31T14:00:00.000+01:00\",\"cost\":0.993094575,\"unitPrice\":0.6542125,\"unitPriceVAT\":0.1308425,\"consumption\":1.518,\"consumptionUnit\":\"kWh\"}]},\"daily\":{\"nodes\":[{\"from\":\"2021-12-01T00:00:00.000+01:00\",\"to\":\"2021-12-02T00:00:00.000+01:00\",\"cost\":106.060999675,\"unitPrice\":1.475837,\"unitPriceVAT\":0.295167,\"consumption\":71.865,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-02T00:00:00.000+01:00\",\"to\":\"2021-12-03T00:00:00.000+01:00\",\"cost\":154.2273203,\"unitPrice\":1.942312,\"unitPriceVAT\":0.388462,\"consumption\":79.404,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-03T00:00:00.000+01:00\",\"to\":\"2021-12-04T00:00:00.000+01:00\",\"cost\":103.512467425,\"unitPrice\":1.45622,\"unitPriceVAT\":0.291244,\"consumption\":71.083,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-04T00:00:00.000+01:00\",\"to\":\"2021-12-05T00:00:00.000+01:00\",\"cost\":82.70974565,\"unitPrice\":0.902147,\"unitPriceVAT\":0.180429,\"consumption\":91.681,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-05T00:00:00.000+01:00\",\"to\":\"2021-12-06T00:00:00.000+01:00\",\"cost\":99.077527775,\"unitPrice\":1.52104,\"unitPriceVAT\":0.304208,\"consumption\":65.138,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-06T00:00:00.000+01:00\",\"to\":\"2021-12-07T00:00:00.000+01:00\",\"cost\":81.2554525625,\"unitPrice\":1.492843,\"unitPriceVAT\":0.298569,\"consumption\":54.43,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-07T00:00:00.000+01:00\",\"to\":\"2021-12-08T00:00:00.000+01:00\",\"cost\":84.6237931,\"unitPrice\":1.502767,\"unitPriceVAT\":0.300553,\"consumption\":56.312,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-08T00:00:00.000+01:00\",\"to\":\"2021-12-09T00:00:00.000+01:00\",\"cost\":72.1906358875,\"unitPrice\":0.900088,\"unitPriceVAT\":0.180018,\"consumption\":80.204,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-09T00:00:00.000+01:00\",\"to\":\"2021-12-10T00:00:00.000+01:00\",\"cost\":38.134279075,\"unitPrice\":0.533361,\"unitPriceVAT\":0.106672,\"consumption\":71.498,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-10T00:00:00.000+01:00\",\"to\":\"2021-12-11T00:00:00.000+01:00\",\"cost\":47.0818948,\"unitPrice\":0.544608,\"unitPriceVAT\":0.108922,\"consumption\":86.451,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-11T00:00:00.000+01:00\",\"to\":\"2021-12-12T00:00:00.000+01:00\",\"cost\":49.6500579125,\"unitPrice\":0.637618,\"unitPriceVAT\":0.127524,\"consumption\":77.868,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-12T00:00:00.000+01:00\",\"to\":\"2021-12-13T00:00:00.000+01:00\",\"cost\":51.5612359125,\"unitPrice\":0.560022,\"unitPriceVAT\":0.112004,\"consumption\":92.07,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-13T00:00:00.000+01:00\",\"to\":\"2021-12-14T00:00:00.000+01:00\",\"cost\":32.533394475,\"unitPrice\":0.572731,\"unitPriceVAT\":0.114546,\"consumption\":56.804,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-14T00:00:00.000+01:00\",\"to\":\"2021-12-15T00:00:00.000+01:00\",\"cost\":34.6287187,\"unitPrice\":0.449461,\"unitPriceVAT\":0.089892,\"consumption\":77.045,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-15T00:00:00.000+01:00\",\"to\":\"2021-12-16T00:00:00.000+01:00\",\"cost\":17.1847222,\"unitPrice\":0.306963,\"unitPriceVAT\":0.061393,\"consumption\":55.983,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-16T00:00:00.000+01:00\",\"to\":\"2021-12-17T00:00:00.000+01:00\",\"cost\":18.02959695,\"unitPrice\":0.281317,\"unitPriceVAT\":0.056263,\"consumption\":64.09,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-17T00:00:00.000+01:00\",\"to\":\"2021-12-18T00:00:00.000+01:00\",\"cost\":22.1979754625,\"unitPrice\":0.300171,\"unitPriceVAT\":0.060034,\"consumption\":73.951,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-18T00:00:00.000+01:00\",\"to\":\"2021-12-19T00:00:00.000+01:00\",\"cost\":17.3707678625,\"unitPrice\":0.284538,\"unitPriceVAT\":0.056908,\"consumption\":61.049,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-19T00:00:00.000+01:00\",\"to\":\"2021-12-20T00:00:00.000+01:00\",\"cost\":38.5211196125,\"unitPrice\":0.29266,\"unitPriceVAT\":0.058532,\"consumption\":131.624,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-20T00:00:00.000+01:00\",\"to\":\"2021-12-21T00:00:00.000+01:00\",\"cost\":63.500660175,\"unitPrice\":0.734774,\"unitPriceVAT\":0.146955,\"consumption\":86.422,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-21T00:00:00.000+01:00\",\"to\":\"2021-12-22T00:00:00.000+01:00\",\"cost\":54.5404124125,\"unitPrice\":0.803518,\"unitPriceVAT\":0.160704,\"consumption\":67.877,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-22T00:00:00.000+01:00\",\"to\":\"2021-12-23T00:00:00.000+01:00\",\"cost\":52.78627495,\"unitPrice\":0.795705,\"unitPriceVAT\":0.159141,\"consumption\":66.339,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-23T00:00:00.000+01:00\",\"to\":\"2021-12-24T00:00:00.000+01:00\",\"cost\":35.979788125,\"unitPrice\":0.506465,\"unitPriceVAT\":0.101293,\"consumption\":71.041,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-24T00:00:00.000+01:00\",\"to\":\"2021-12-25T00:00:00.000+01:00\",\"cost\":37.692666025,\"unitPrice\":0.402111,\"unitPriceVAT\":0.080422,\"consumption\":93.737,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-25T00:00:00.000+01:00\",\"to\":\"2021-12-26T00:00:00.000+01:00\",\"cost\":39.78087125,\"unitPrice\":0.40795,\"unitPriceVAT\":0.08159,\"consumption\":97.514,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-26T00:00:00.000+01:00\",\"to\":\"2021-12-27T00:00:00.000+01:00\",\"cost\":43.0808987,\"unitPrice\":0.635421,\"unitPriceVAT\":0.127084,\"consumption\":67.799,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-27T00:00:00.000+01:00\",\"to\":\"2021-12-28T00:00:00.000+01:00\",\"cost\":58.3979845625,\"unitPrice\":0.744692,\"unitPriceVAT\":0.148938,\"consumption\":78.419,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-28T00:00:00.000+01:00\",\"to\":\"2021-12-29T00:00:00.000+01:00\",\"cost\":68.6274829375,\"unitPrice\":0.783598,\"unitPriceVAT\":0.15672,\"consumption\":87.58,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-29T00:00:00.000+01:00\",\"to\":\"2021-12-30T00:00:00.000+01:00\",\"cost\":62.8214135875,\"unitPrice\":0.869501,\"unitPriceVAT\":0.1739,\"consumption\":72.25,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-12-30T00:00:00.000+01:00\",\"to\":\"2021-12-31T00:00:00.000+01:00\",\"cost\":29.5539776375,\"unitPrice\":0.691305,\"unitPriceVAT\":0.138261,\"consumption\":42.751,\"consumptionUnit\":\"kWh\"}]},\"monthly\":{\"nodes\":[{\"from\":\"2021-01-01T00:00:00.000+01:00\",\"to\":\"2021-02-01T00:00:00.000+01:00\",\"cost\":1496.12567765,\"unitPrice\":0.575925,\"unitPriceVAT\":0.115185,\"consumption\":2597.78,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-02-01T00:00:00.000+01:00\",\"to\":\"2021-03-01T00:00:00.000+01:00\",\"cost\":1314.7741036625,\"unitPrice\":0.558941,\"unitPriceVAT\":0.111788,\"consumption\":2352.259,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-03-01T00:00:00.000+01:00\",\"to\":\"2021-04-01T00:00:00.000+02:00\",\"cost\":669.955541375,\"unitPrice\":0.321934,\"unitPriceVAT\":0.064387,\"consumption\":2081.031,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-04-01T00:00:00.000+02:00\",\"to\":\"2021-05-01T00:00:00.000+02:00\",\"cost\":652.4670385125,\"unitPrice\":0.333466,\"unitPriceVAT\":0.066693,\"consumption\":1956.621,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-05-01T00:00:00.000+02:00\",\"to\":\"2021-06-01T00:00:00.000+02:00\",\"cost\":463.37073145,\"unitPrice\":0.462631,\"unitPriceVAT\":0.092526,\"consumption\":1001.599,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-06-01T00:00:00.000+02:00\",\"to\":\"2021-07-01T00:00:00.000+02:00\",\"cost\":362.0896929625,\"unitPrice\":0.433144,\"unitPriceVAT\":0.086629,\"consumption\":835.957,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-07-01T00:00:00.000+02:00\",\"to\":\"2021-08-01T00:00:00.000+02:00\",\"cost\":424.3164585375,\"unitPrice\":0.584322,\"unitPriceVAT\":0.116864,\"consumption\":726.169,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-08-01T00:00:00.000+02:00\",\"to\":\"2021-09-01T00:00:00.000+02:00\",\"cost\":598.565520525,\"unitPrice\":0.706662,\"unitPriceVAT\":0.141332,\"consumption\":847.032,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-09-01T00:00:00.000+02:00\",\"to\":\"2021-10-01T00:00:00.000+02:00\",\"cost\":637.790824275,\"unitPrice\":0.673083,\"unitPriceVAT\":0.134617,\"consumption\":947.566,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-10-01T00:00:00.000+02:00\",\"to\":\"2021-11-01T00:00:00.000+01:00\",\"cost\":437.1167829875,\"unitPrice\":0.288513,\"unitPriceVAT\":0.057703,\"consumption\":1515.07,\"consumptionUnit\":\"kWh\"},{\"from\":\"2021-11-01T00:00:00.000+01:00\",\"to\":\"2021-12-01T00:00:00.000+01:00\",\"cost\":1154.2979161125,\"unitPrice\":0.572333,\"unitPriceVAT\":0.114467,\"consumption\":2016.83,\"consumptionUnit\":\"kWh\"}]},\"yearly\":{\"nodes\":[{\"from\":\"2020-01-01T00:00:00.000+01:00\",\"to\":\"2021-01-01T00:00:00.000+01:00\",\"cost\":1465.24875625,\"unitPrice\":0.127965,\"unitPriceVAT\":0.025593,\"consumption\":11450.413,\"consumptionUnit\":\"kWh\"}]},\"currentSubscription\":{\"status\":\"running\",\"priceInfo\":{\"current\":{\"total\":0.6702,\"energy\":0.5281,\"tax\":0.1421,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T14:00:00.000+01:00\"},\"today\":[{\"total\":0.3848,\"energy\":0.2998,\"tax\":0.085,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T00:00:00.000+01:00\"},{\"total\":0.3362,\"energy\":0.261,\"tax\":0.0752,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T01:00:00.000+01:00\"},{\"total\":0.3234,\"energy\":0.2507,\"tax\":0.0727,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T02:00:00.000+01:00\"},{\"total\":0.3095,\"energy\":0.2396,\"tax\":0.0699,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T03:00:00.000+01:00\"},{\"total\":0.3195,\"energy\":0.2476,\"tax\":0.0719,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T04:00:00.000+01:00\"},{\"total\":0.3148,\"energy\":0.2438,\"tax\":0.071,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T05:00:00.000+01:00\"},{\"total\":0.3491,\"energy\":0.2713,\"tax\":0.0778,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T06:00:00.000+01:00\"},{\"total\":0.3885,\"energy\":0.3028,\"tax\":0.0857,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T07:00:00.000+01:00\"},{\"total\":0.4172,\"energy\":0.3258,\"tax\":0.0914,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T08:00:00.000+01:00\"},{\"total\":0.4494,\"energy\":0.3515,\"tax\":0.0979,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T09:00:00.000+01:00\"},{\"total\":0.4985,\"energy\":0.3908,\"tax\":0.1077,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T10:00:00.000+01:00\"},{\"total\":0.5766,\"energy\":0.4533,\"tax\":0.1233,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T11:00:00.000+01:00\"},{\"total\":0.6394,\"energy\":0.5035,\"tax\":0.1359,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T12:00:00.000+01:00\"},{\"total\":0.6542,\"energy\":0.5154,\"tax\":0.1388,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T13:00:00.000+01:00\"},{\"total\":0.6702,\"energy\":0.5281,\"tax\":0.1421,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T14:00:00.000+01:00\"},{\"total\":0.7006,\"energy\":0.5525,\"tax\":0.1481,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T15:00:00.000+01:00\"},{\"total\":0.6918,\"energy\":0.5454,\"tax\":0.1464,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T16:00:00.000+01:00\"},{\"total\":0.6686,\"energy\":0.5268,\"tax\":0.1418,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T17:00:00.000+01:00\"},{\"total\":0.6364,\"energy\":0.5011,\"tax\":0.1353,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2021-12-31T18:00:00.000+01:00\"},{\"total\":0.6089,\"energy\":0.4791,\"tax\":0.1298,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T19:00:00.000+01:00\"},{\"total\":0.4336,\"energy\":0.3389,\"tax\":0.0947,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T20:00:00.000+01:00\"},{\"total\":0.4227,\"energy\":0.3301,\"tax\":0.0926,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T21:00:00.000+01:00\"},{\"total\":0.4134,\"energy\":0.3228,\"tax\":0.0906,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2021-12-31T22:00:00.000+01:00\"},{\"total\":0.3812,\"energy\":0.297,\"tax\":0.0842,\"currency\":\"NOK\",\"level\":\"VERY_CHEAP\",\"startsAt\":\"2021-12-31T23:00:00.000+01:00\"}],\"tomorrow\":[{\"total\":0.592,\"energy\":0.4656,\"tax\":0.1264,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T00:00:00.000+01:00\"},{\"total\":0.5261,\"energy\":0.4129,\"tax\":0.1132,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T01:00:00.000+01:00\"},{\"total\":0.5368,\"energy\":0.4214,\"tax\":0.1154,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T02:00:00.000+01:00\"},{\"total\":0.5641,\"energy\":0.4433,\"tax\":0.1208,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T03:00:00.000+01:00\"},{\"total\":0.4804,\"energy\":0.3763,\"tax\":0.1041,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T04:00:00.000+01:00\"},{\"total\":0.5058,\"energy\":0.3966,\"tax\":0.1092,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T05:00:00.000+01:00\"},{\"total\":0.5169,\"energy\":0.4055,\"tax\":0.1114,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T06:00:00.000+01:00\"},{\"total\":0.5502,\"energy\":0.4322,\"tax\":0.118,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T07:00:00.000+01:00\"},{\"total\":0.6274,\"energy\":0.4939,\"tax\":0.1335,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2022-01-01T08:00:00.000+01:00\"},{\"total\":0.6277,\"energy\":0.4941,\"tax\":0.1336,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2022-01-01T09:00:00.000+01:00\"},{\"total\":0.6253,\"energy\":0.4922,\"tax\":0.1331,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2022-01-01T10:00:00.000+01:00\"},{\"total\":0.6206,\"energy\":0.4884,\"tax\":0.1322,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2022-01-01T11:00:00.000+01:00\"},{\"total\":0.615,\"energy\":0.484,\"tax\":0.131,\"currency\":\"NOK\",\"level\":\"NORMAL\",\"startsAt\":\"2022-01-01T12:00:00.000+01:00\"},{\"total\":0.5621,\"energy\":0.4417,\"tax\":0.1204,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T13:00:00.000+01:00\"},{\"total\":0.5392,\"energy\":0.4234,\"tax\":0.1158,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T14:00:00.000+01:00\"},{\"total\":0.5356,\"energy\":0.4205,\"tax\":0.1151,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T15:00:00.000+01:00\"},{\"total\":0.5382,\"energy\":0.4226,\"tax\":0.1156,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T16:00:00.000+01:00\"},{\"total\":0.5169,\"energy\":0.4055,\"tax\":0.1114,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T17:00:00.000+01:00\"},{\"total\":0.5109,\"energy\":0.4007,\"tax\":0.1102,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T18:00:00.000+01:00\"},{\"total\":0.491,\"energy\":0.3848,\"tax\":0.1062,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T19:00:00.000+01:00\"},{\"total\":0.4435,\"energy\":0.3468,\"tax\":0.0967,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T20:00:00.000+01:00\"},{\"total\":0.4156,\"energy\":0.3245,\"tax\":0.0911,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T21:00:00.000+01:00\"},{\"total\":0.4206,\"energy\":0.3285,\"tax\":0.0921,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T22:00:00.000+01:00\"},{\"total\":0.4151,\"energy\":0.3241,\"tax\":0.091,\"currency\":\"NOK\",\"level\":\"CHEAP\",\"startsAt\":\"2022-01-01T23:00:00.000+01:00\"}]}}}]}}}'\n \n  jsonTable = json.decode(apiResult) -- Decode the json string from api to lua-table \n  \n  self:getValues()\n  self:updateLabels()\n  self:updateProperties()\n  self:updateChildDevices() \n  \n  self:logging(3,\"SetTimeout \" ..interval ..\" seconds\")\n  fibaro.setTimeout(interval*1000, function() \n     self:simData()\n  end)\nend\n\n\nfunction QuickApp:getData()\n  self:logging(3,\"getData\")\n  data = os.date(\"*t\")\n  local url = \"https://api.tibber.com/v1-beta/gql\"\n  local requestBody = '{\"query\": \"{viewer {homes {hourly: consumption(resolution: HOURLY, last: ' ..data.hour ..') {nodes {from to cost unitPrice unitPriceVAT consumption consumptionUnit}}daily: consumption(resolution: DAILY, last: ' ..data.day-1 ..') {nodes {from to cost unitPrice unitPriceVAT consumption consumptionUnit}}monthly: consumption(resolution: MONTHLY, last: ' ..data.month-1 ..') {nodes {from to cost unitPrice unitPriceVAT consumption consumptionUnit}}yearly: consumption(resolution: ANNUAL, last: ' ..data.year-2000 ..') {nodes {from to cost unitPrice unitPriceVAT consumption consumptionUnit}}currentSubscription {status priceInfo {current {total energy tax currency level startsAt}today {total energy tax currency level startsAt}tomorrow {total energy tax currency level startsAt}}}}}}\"}'\n  \n  self:logging(3,\"requestBody: \" ..requestBody)\n\n  http:request(url, {\n    options = {\n      data = requestBody,\n      method = \"POST\",\n      headers = {\n        [\"Content-Type\"] = \"application/json\",\n        [\"Accept\"] = \"application/json\",\n        [\"Authorization\"] = \"Bearer \" ..token,\n      }\n    },\n    success = function(response) \n        self:logging(3,\"response status: \" ..response.status)\n        self:logging(3,\"headers: \" ..response.headers[\"Content-Type\"])\n        self:logging(2,\"Response data: \" ..response.data)\n\n        if response.data == nil or response.data == \"\" or response.data == \"[]\" or response.status > 200 then -- Check for empty result\n          self:warning(\"Temporarily no production data from Tibber Monitor\")\n          self:logging(3,\"SetTimeout \" ..interval ..\" seconds\")\n          fibaro.setTimeout(interval*1000, function() \n            self:getdata()\n          end)\n        end\n        \n        response.data = response.data:gsub(\"null\", \"0\") -- clean up the response.data by replacing null with 0\n        --self:logging(3,\"Response data withoot null: \" ..response.data)\n\n        jsonTable = json.decode(response.data) -- JSON decode from api to lua-table\n\n        self:getValues()\n        self:updateLabels()\n        self:updateProperties()\n        self:updateChildDevices() \n\n      end,\n      error = function(error)\n        self:error(\"error: \" ..json.encode(error))\n        self:updateProperty(\"log\", \"error: \" ..json.encode(error))\n      end\n    }) \n  \n  self:logging(3,\"SetTimeout \" ..interval ..\" seconds\")\n  fibaro.setTimeout(interval*1000, function() \n     self:getData()\n  end)\nend\n\n\nfunction QuickApp:createVariables() -- Create all Variables \n  jsonTable = {}\n  jsonPrices = {}\n  data = {}\n  data.hEnergy = 0 -- Hourly data\n  data.hCost = 0\n  data.dEnergy = 0 -- Daily data\n  data.dCost = 0\n  data.mEnergy = 0 -- Monthly data\n  data.mCost = 0\n  data.yEnergy = 0 -- Yearly data\n  data.yCost = 0\n  data.tEnergy = 0 -- Total data\n  data.tCost = 0\n  data.minPrice = 0 -- Min/Max Price\n  data.minLevel = \"\"\n  data.minStartsAt = \"\"\n  data.maxPrice = 0\n  data.maxLevel = \"\"\n  data.maxStartsAt = \"\"\n  data.h1Percentage = 0 -- Percentage +1 hour\n  data.h2Percentage = 0\n  data.h3Percentage = 0\n  data.h4Percentage = 0\n  data.h5Percentage = 0\n  data.tPrice = 0 -- Todays Price\n  data.gPrice = 0\n  data.currency = \"\"\n  data.level = \"\"\n  data.tax = 0  \n  data.startsAt = \"\"\nend\n\n\nfunction QuickApp:getQuickAppVariables() -- Get all Quickapp Variables or create them\n  token = self:getVariable(\"token\")\n  homeNr = tonumber(self:getVariable(\"homeNr\"))\n  extraCost = tonumber(self:getVariable(\"extraCost\")) \n  interval = tonumber(self:getVariable(\"interval\")) \n  httpTimeout = tonumber(self:getVariable(\"httpTimeout\")) \n  debugLevel = tonumber(self:getVariable(\"debugLevel\"))\n  setGlobalVar = self:getVariable(\"setGlobalVar\")\n  local icon = tonumber(self:getVariable(\"icon\")) \n\n  -- Check existence of the mandatory variables, if not, create them with default values\n  if token == \"\" or token == nil then\n    token = \"476c477d8a039529478ebd690d35ddd80e3308ffc49b59c65b142321aee963a4\" -- This token is just an demo example, only for demo purpose\n    self:setVariable(\"token\",token)\n    self:trace(\"Added QuickApp variable with DEMO (!) token\")\n  end\n  if homeNr == \"\" or homeNr == nil then\n    homeNr = \"1\"\n    self:setVariable(\"homeNr\",homeNr)\n    self:trace(\"Added QuickApp variable homeNr\")\n    homeNr = tonumber(homeNr)\n  end\n  if extraCost == \"\" or extraCost == nil then\n    extraCost = \"0\"\n    self:setVariable(\"extraCost\",extraCost)\n    self:trace(\"Added QuickApp variable extraCost\")\n    extraCost = tonumber(extraCost)\n  end\n  if interval == \"\" or interval == nil then\n    interval = \"3600\" \n    self:setVariable(\"interval\",interval)\n    self:trace(\"Added QuickApp variable interval\")\n    interval = tonumber(interval)\n  end\n  if httpTimeout == \"\" or httpTimeout == nil then\n    httpTimeout = \"5\" -- Default http timeout \n    self:setVariable(\"httpTimeout\",httpTimeout)\n    self:trace(\"Added QuickApp variable httpTimeout\")\n    httpTimeout = tonumber(httpTimeout)\n  end \n  if debugLevel == \"\" or debugLevel == nil then\n    debugLevel = \"1\" -- Default debug level\n    self:setVariable(\"debugLevel\",debugLevel)\n    self:trace(\"Added QuickApp variable debugLevel\")\n    debugLevel = tonumber(debugLevel)\n  end\n  if setGlobalVar == \"\" or setGlobalVar == nil then \n    setGlobalVar = false -- Default SetGlobalVar is falso (No use of Global Variables)\n    self:setVariable(\"setGlobalVar\",tostring(setGlobalVar))\n    self:trace(\"Added QuickApp variable setGlobalVar\")\n  end\n  if setGlobalVar == \"true\" then \n    setGlobalVar = true \n  else\n    setGlobalVar = false\n  end\n  if token == nil or token == \"\"  or token == \"0\" then -- Check mandatory token \n    self:error(\"Token is empty! Get your token from the Tibber website and copy the token to the quickapp variable\")\n    self:warning(\"No token Switched to Simulation Mode\")\n    debugLevel = 4 -- Simulation mode due to empty token\n  end\n  if icon == \"\" or icon == nil then \n    icon = \"0\" -- Default no user defined icon \n    self:setVariable(\"icon\",icon)\n    self:trace(\"Added QuickApp variable icon\")\n    icon = tonumber(icon)\n  end\n  if icon ~= 0 then \n    self:updateProperty(\"deviceIcon\", icon) -- Set user defined icon \n  end\nend\n  \n\nfunction QuickApp:setupChildDevices() -- Setup Child Devices\n  local cdevs = api.get(\"/devices?parentId=\"..self.id) or {} -- Pick up all Child Devices\n  function self:initChildDevices() end -- Null function, else Fibaro calls it after onInit()...\n\n  if #cdevs == 0 then -- If no Child Devices, create them\n    local initChildData = { \n      {className=\"hEnergy\", name=\"Hourly Energy\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"hCost\", name=\"Hourly Cost\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"dEnergy\", name=\"Daily Energy\", type=\"com.fibaro.energyMeter\"}, -- Device for values Energy Panel\n      {className=\"dCost\", name=\"Daily Cost\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"mEnergy\", name=\"Monthly Energy\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"mCost\", name=\"Monthly Cost\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"yEnergy\", name=\"Yearly Energy\", type=\"com.fibaro.multilevelSensor\"}, \n      {className=\"yCost\", name=\"Yearly Cost\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"tEnergy\", name=\"Total Energy\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"tCost\", name=\"Total Cost\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"hPrice\", name=\"Current Price\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"minPrice\", name=\"Minimum Price\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"maxPrice\", name=\"Maximum Price\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"h1Percentage\", name=\"+1 hour\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"h2Percentage\", name=\"+2 hour\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"h3Percentage\", name=\"+3 hour\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"h4Percentage\", name=\"+4 hour\", type=\"com.fibaro.multilevelSensor\"},\n      {className=\"h5Percentage\", name=\"+5 hour\", type=\"com.fibaro.multilevelSensor\"},\n    }\n    for _,c in ipairs(initChildData) do\n      local ips = UI and self:makeInitialUIProperties(UI or {}) or {}\n      local child = self:createChildDevice(\n        {name = c.name,\n          type=c.type,\n          properties = {viewLayout = ips.viewLayout, uiCallbacks = ips.uiCallbacks},\n          interfaces = {\"quickApp\"}, \n        },\n        _G[c.className] -- Fetch class constructor from class name\n      )\n      child:setVariable(\"className\",c.className) -- Save class name so we know when we load it next time\n    end   \n  else \n    for _,child in ipairs(cdevs) do\n      local className = getChildVariable(child,\"className\") -- Fetch child class name\n      local childObject = _G[className](child) -- Create child object from the constructor name\n      self.childDevices[child.id]=childObject\n      childObject.parent = self -- Setup parent link to device controller \n    end\n  end\nend\n\n\nfunction QuickApp:onInit()\n  __TAG = fibaro.getName(plugin.mainDeviceId) ..\" ID:\" ..plugin.mainDeviceId\n  self:debug(\"onInit\") \n\n  self:setupChildDevices() -- Setup the Child Devices\n\n  if not api.get(\"/devices/\"..self.id).enabled then\n    self:warning(\"Device\", fibaro.getName(plugin.mainDeviceId), \"is disabled\")\n    return\n  end\n  \n  self:getQuickAppVariables() \n  self:createVariables()\n  \n  http = net.HTTPClient({timeout=httpTimeout*1000})\n  \n  if tonumber(debugLevel) >= 4 then \n    self:simData() -- Go in simulation\n  else\n    self:getData() -- Get data from the Tibber platform\n  end\nend\n\n-- EOF "}]}